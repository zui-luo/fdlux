<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»„ç»‡æ¶æ„ - åŒæ¨¡å¼å¯¹æ¯”</title>
    <style>
        :root {
            --primary-blue: #2A7BFC;
            --bg-gray: #F5F6F7;
            --text-main: #1D1D1F;
            --text-sub: #8E8E93;
            --border-color: #E5E5E5;
            --icon-org-bg: #FF9F0A; 
            --icon-user-blue: #2A7BFC;
            --icon-user-green: #34C759;
            --icon-user-teal: #30B0C7;
            --icon-user-purple: #AF52DE;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* æ¨¡å¼åˆ‡æ¢å™¨ */
        .mode-switcher {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            background: #fff;
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            gap: 4px;
        }
        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-sub);
        }
        .mode-btn.active {
            background: var(--primary-blue);
            color: #fff;
            font-weight: 500;
        }

        .mobile-shell {
            width: 375px;
            height: 812px;
            background: #fff;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-radius: 40px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .status-bar { height: 44px; width: 100%; background: #fff; flex-shrink: 0; }
        .nav-bar {
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: #fff;
            flex-shrink: 0;
        }
        .nav-back { cursor: pointer; font-size: 20px; padding: 5px; width: 40px;}
        .nav-title { font-weight: 600; font-size: 17px; }
        .nav-actions { font-size: 20px; letter-spacing: 1px; width: 40px; text-align: right; color: var(--text-main);}

        .sticky-header {
            background: #fff;
            padding-bottom: 8px;
            z-index: 10;
            border-bottom: 0.5px solid var(--border-color);
        }

        .breadcrumbs {
            padding: 8px 16px;
            font-size: 13px;
            color: var(--text-sub);
            white-space: nowrap;
            overflow-x: auto;
            scrollbar-width: none; 
            display: flex;
            align-items: center;
            height: 30px;
        }
        .breadcrumbs::-webkit-scrollbar { display: none; }
        .crumb-item {
            color: var(--text-main);
            cursor: pointer;
            flex-shrink: 0;
        }
        .crumb-item.active {
            color: var(--primary-blue);
            font-weight: 500;
        }
        .crumb-separator {
            margin: 0 4px;
            color: var(--text-sub);
            font-size: 10px;
            flex-shrink: 0;
        }

        .search-container { padding: 6px 16px; }
        .search-box {
            background: var(--bg-gray);
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 10px;
        }
        .search-icon { color: var(--text-sub); margin-right: 8px; }
        .search-input {
            border: none;
            background: transparent;
            flex: 1;
            font-size: 14px;
            outline: none;
            color: var(--text-main);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            background: #fff;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 0.5px solid #F0F0F0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .list-item:active { background-color: var(--bg-gray); }
        
        .avatar {
            width: 40px; height: 40px; border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            margin-right: 12px; flex-shrink: 0; color: #fff; font-size: 14px; font-weight: 500;
        }
        .avatar.org {
            background-color: var(--icon-org-bg);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='20' height='20'%3E%3Cpath d='M12 2L2 7V17L12 22L22 17V7L12 2Z' fill='none' stroke='white' stroke-width='2' stroke-linejoin='round'/%3E%3Cpath d='M12 22V12' stroke='white' stroke-width='2'/%3E%3Cpath d='M2 7L12 12L22 7' stroke='white' stroke-width='2'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
        }
        .user-round { border-radius: 50%; } 
        .avatar.user-blue { background-color: var(--icon-user-blue); }
        .avatar.user-green { background-color: var(--icon-user-green); }
        .avatar.user-teal { background-color: var(--icon-user-teal); }
        .avatar.user-purple { background-color: var(--icon-user-purple); }

        .info {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
        }
        .name {
            font-size: 16px; color: var(--text-main); margin-bottom: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .sub-info {
            font-size: 12px; color: var(--text-sub);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .highlight { color: var(--primary-blue); font-weight: bold; }
        .arrow { color: #C7C7CC; font-size: 18px; margin-left: 8px;}
        .tag-group { display: flex; gap: 4px; }
        .tag {
            background: #E1F0FF; color: var(--primary-blue); font-size: 10px; padding: 1px 5px; border-radius: 4px;
        }
        .desktop-hint {
            position: absolute; bottom: 20px; color: #666; font-size: 14px; text-align: center; width: 100%;
        }
        /* è°ƒè¯•çŠ¶æ€æ˜¾ç¤º */
        .debug-fixed {
            position: absolute; top:0; left: -260px; width: 240px; background: rgba(0,0,0,0.8); color: #0f0; 
            font-family: monospace; padding: 10px; border-radius: 8px; font-size: 12px; height: 300px; overflow-y:auto;
        }

        /* é€šè®¯å½•é¡µé¢æ ·å¼ */
        .page {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }
        .page.active {
            display: flex;
        }

        /* æ ‡ç­¾é¡µåˆ‡æ¢ */
        .tabs {
            display: flex;
            padding: 0 16px;
            border-bottom: 0.5px solid var(--border-color);
            background: #fff;
        }
        .tab {
            padding: 12px 0;
            margin-right: 24px;
            font-size: 16px;
            color: var(--text-sub);
            cursor: pointer;
            position: relative;
            border: none;
            background: transparent;
        }
        .tab.active {
            color: var(--primary-blue);
            font-weight: 500;
        }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-blue);
        }

        /* é€šè®¯å½•æœç´¢æ¡† */
        .contact-search-container {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #fff;
        }
        .contact-search-box {
            flex: 1;
            background: var(--bg-gray);
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 10px;
        }
        .contact-add-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--bg-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        /* åˆ†ç±»é¡¹ï¼ˆéƒ¨é—¨ã€è§’è‰²ï¼‰ */
        .category-section {
            background: #fff;
            border-bottom: 8px solid var(--bg-gray);
        }
        .category-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 0.5px solid #F0F0F0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .category-item:active {
            background-color: var(--bg-gray);
        }
        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 20px;
        }
        .category-icon.dept {
            background-color: var(--icon-org-bg);
        }
        .category-icon.role {
            background-color: var(--icon-user-blue);
        }

        /* æˆå‘˜åˆ—è¡¨æ ‡é¢˜ */
        .section-title {
            padding: 12px 16px;
            font-size: 14px;
            color: var(--text-sub);
            background: #fff;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <!-- æ¨¡å¼åˆ‡æ¢å™¨ -->
    <div class="mode-switcher">
        <button class="mode-btn active" data-mode="parent" onclick="switchMode('parent')">è¿”å›ä¸Šä¸€å±‚</button>
        <button class="mode-btn" data-mode="back" onclick="switchMode('back')">è¿”å›=å›é€€</button>
    </div>

    <!-- è°ƒè¯•é¢æ¿ï¼šç”¨äºç›´è§‚å±•ç¤ºæ ˆçš„å˜åŒ– -->
    <div class="debug-fixed" id="debugPanel" style="display: none;">History Stack:</div>

    <div class="mobile-shell">
        <div class="status-bar"></div>

        <!-- é€šè®¯å½•é¡µé¢ -->
        <div class="page active" id="contactPage">
            <div class="nav-bar">
                <div class="nav-back" style="visibility: hidden;">â®</div>
                <div class="nav-title">é€šè®¯å½•</div>
                <div class="nav-actions">
                    <span style="margin-right: 8px;">â€¢â€¢â€¢</span>
                    <span>â—</span>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('internal')">å†…éƒ¨ç»„ç»‡</button>
                <button class="tab" onclick="switchTab('external')">å¤–éƒ¨ç»„ç»‡</button>
            </div>

            <div class="contact-search-container">
                <div class="contact-search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" class="search-input" id="contactSearchInput" placeholder="æœç´¢æˆå‘˜" autocomplete="off">
                </div>
                <div class="contact-add-btn">ğŸ‘¥</div>
            </div>

            <div class="content-area">
                <div class="category-section">
                    <div class="category-item" onclick="enterOrgStructure()">
                        <div class="category-icon dept">ğŸ¢</div>
                        <div class="info">
                            <div class="name">éƒ¨é—¨</div>
                        </div>
                        <div class="arrow">â€º</div>
                    </div>
                    <div class="category-item">
                        <div class="category-icon role">ğŸ‘¥</div>
                        <div class="info">
                            <div class="name">è§’è‰²</div>
                        </div>
                        <div class="arrow">â€º</div>
                    </div>
                </div>

                <div class="section-title">å…¨éƒ¨æˆå‘˜</div>
                <div id="memberList"></div>
            </div>
        </div>

        <!-- ç»„ç»‡æ¶æ„é¡µé¢ -->
        <div class="page" id="orgPage">
            <div class="nav-bar">
                <div class="nav-back" onclick="goBackFromOrg()">â®</div>
                <div class="nav-title">ç»„ç»‡æ¶æ„</div>
                <div class="nav-actions">â€¢â€¢â€¢</div>
            </div>

            <div class="sticky-header">
                <div class="breadcrumbs" id="breadcrumbs"></div>
                <div class="search-container">
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢éƒ¨é—¨ã€æˆå‘˜" autocomplete="off">
                    </div>
                </div>
            </div>

            <div class="content-area" id="listContainer"></div>
        </div>
    </div>

    <div class="desktop-hint" id="desktopHint"></div>

<script>
    // 1. æ•°æ®ç»“æ„ï¼ˆä½¿ç”¨æ›´è¯¦ç»†çš„ç‰ˆæœ¬ï¼‰
    const orgData = [
        {
            id: 'root', name: 'æœªæ¥ç§‘æŠ€é›†å›¢', type: 'dept',
            children: [
                {
                    id: 'L2-tech', name: 'äº§ç ”ä¸­å¿ƒ', type: 'dept', children: [
                        {
                            id: 'L3-dev', name: 'æŠ€æœ¯éƒ¨', type: 'dept', children: [
                                {
                                    id: 'L4-backend', name: 'åç«¯æ¶æ„ç»„', type: 'dept', children: [
                                        { id: 'L5-pay', name: 'æ”¯ä»˜ä¸­å°å°é˜Ÿ', type: 'dept', children: [
                                                { id: 'u-pay-1', name: 'å¼ æ¶æ„', type: 'user', colorClass: 'user-blue', title: 'P8' },
                                                { id: 'u-pay-2', name: 'ç‹ä»£ç ', type: 'user', colorClass: 'user-green', title: 'P7' }
                                        ]},
                                        { id: 'u-bk-lead', name: 'èµµåç«¯', type: 'user', colorClass: 'user-purple', title: 'TL' }
                                    ]
                                },
                            ]
                        },
                        { id: 'L3-prod', name: 'äº§å“éƒ¨', type: 'dept', children: [] }
                    ]
                },
                {
                    id: 'L2-sale', name: 'è¥é”€ä¸­å¿ƒ', type: 'dept', children: [
                        { id: 'L3-east', name: 'åä¸œå¤§åŒº', type: 'dept', children: [] }
                    ]
                },
                { id: 'u-ceo', name: 'é’±CEO', type: 'user', colorClass: 'user-blue', title: 'CEO' }
            ]
        }
    ];

    // 2. æˆå‘˜æ•°æ®ï¼ˆç”¨äºé€šè®¯å½•é¡µé¢ï¼‰
    const memberData = [
        { id: 'm1', name: 'Zui', colorClass: 'user-blue', title: 'ä¼ä¸šåˆ›å»ºè€…' },
        { id: 'm2', name: 'æˆå‘˜1', colorClass: 'user-blue' },
        { id: 'm3', name: 'æˆå‘˜2', colorClass: 'user-green' },
        { id: 'm4', name: 'æˆå‘˜3', colorClass: 'user-teal' },
        { id: 'm5', name: 'æˆå‘˜4', colorClass: 'user-purple' },
        { id: 'm6', name: 'æˆå‘˜5', colorClass: 'user-blue' },
    ];

    // 3. çŠ¶æ€ç®¡ç†
    let currentMode = 'parent'; // 'parent' æˆ– 'back'
    let navigationStack = [{ id: 'root', keyword: '' }]; 
    let currentPage = 'contact'; // 'contact' æˆ– 'org'
    let currentTab = 'internal'; // 'internal' æˆ– 'external'

    const listContainer = document.getElementById('listContainer');
    const breadcrumbsContainer = document.getElementById('breadcrumbs');
    const searchInput = document.getElementById('searchInput');
    const debugPanel = document.getElementById('debugPanel');
    const desktopHint = document.getElementById('desktopHint');
    const contactPage = document.getElementById('contactPage');
    const orgPage = document.getElementById('orgPage');
    const contactSearchInput = document.getElementById('contactSearchInput');
    const memberList = document.getElementById('memberList');

    // è¾…åŠ©å‡½æ•°
    function findNodeById(id, nodes = orgData) {
        for (let node of nodes) {
            if (node.id === id) return node;
            if (node.children) {
                const found = findNodeById(id, node.children);
                if (found) return found;
            }
        }
        return null;
    }

    function getPath(targetId, nodes = orgData, currentPath = []) {
        for (let node of nodes) {
            const newPath = [...currentPath, node];
            if (node.id === targetId) return newPath;
            if (node.children) {
                const childPath = getPath(targetId, node.children, newPath);
                if (childPath) return childPath;
            }
        }
        return null;
    }

    function searchGlobal(keyword, startNodeId) {
        let results = [];
        // æ‰¾åˆ°èµ·å§‹èŠ‚ç‚¹
        const startNode = findNodeById(startNodeId);
        if (!startNode) return results;
        
        // åªæœç´¢èµ·å§‹èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹
        function traverse(nodes, parentPathName) {
            nodes.forEach(node => {
                if (node.name.includes(keyword)) results.push({ ...node, fullPathName: parentPathName });
                if (node.children) traverse(node.children, parentPathName ? `${parentPathName} / ${node.name}` : node.name);
            });
        }
        
        // ä»èµ·å§‹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å¼€å§‹æœç´¢ï¼ˆä¸åŒ…æ‹¬èµ·å§‹èŠ‚ç‚¹æœ¬èº«ï¼‰
        if (startNode.children) {
            traverse(startNode.children, startNode.name);
        }
        
        return results;
    }

    function highlightText(text, keyword) {
        if (!keyword) return text;
        const reg = new RegExp(`(${keyword})`, 'gi');
        return text.replace(reg, '<span class="highlight">$1</span>');
    }

    // 3. é¡µé¢åˆ‡æ¢å’Œé€šè®¯å½•ç›¸å…³å‡½æ•°
    window.switchTab = function(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach((t, index) => {
            if ((tab === 'internal' && index === 0) || (tab === 'external' && index === 1)) {
                t.classList.add('active');
            } else {
                t.classList.remove('active');
            }
        });
        renderContactPage();
    };

    window.enterOrgStructure = function() {
        currentPage = 'org';
        contactPage.classList.remove('active');
        orgPage.classList.add('active');
        // é‡ç½®ç»„ç»‡æ¶æ„çŠ¶æ€
        navigationStack = [{ id: 'root', keyword: '' }];
        render();
    };

    window.goBackFromOrg = function() {
        // è¿”å›é€šè®¯å½•é¡µé¢
        currentPage = 'contact';
        contactPage.classList.add('active');
        orgPage.classList.remove('active');
    };

    function renderContactPage() {
        const keyword = contactSearchInput.value.trim();
        let filteredMembers = memberData;
        
        if (keyword) {
            filteredMembers = memberData.filter(m => m.name.includes(keyword));
        }

        memberList.innerHTML = '';
        if (filteredMembers.length === 0) {
            memberList.innerHTML = '<div style="text-align:center;color:#999;padding:20px">æ— ç»“æœ</div>';
        } else {
            filteredMembers.forEach(member => {
                const el = document.createElement('div');
                el.className = 'list-item';
                el.innerHTML = `
                    <div class="avatar ${member.colorClass} user-round">${member.name[0]}</div>
                    <div class="info">
                        <div class="name">${highlightText(member.name, keyword)}</div>
                    </div>
                    ${member.title ? `<div class="tag-group"><div class="tag">${member.title}</div></div>` : ''}
                `;
                memberList.appendChild(el);
            });
        }
    }

    // é€šè®¯å½•æœç´¢ç›‘å¬
    contactSearchInput.addEventListener('input', () => {
        renderContactPage();
    });

    // 4. æ¨¡å¼åˆ‡æ¢
    window.switchMode = function(mode) {
        currentMode = mode;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        
        // é‡ç½®çŠ¶æ€æ ˆ
        navigationStack = [{ id: 'root', keyword: '' }];
        
        // æ›´æ–°æç¤ºæ–‡æœ¬
        updateHint();
        
        // æ˜¾ç¤º/éšè—è°ƒè¯•é¢æ¿ï¼ˆä»…åœ¨å›é€€æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
        debugPanel.style.display = mode === 'back' ? 'block' : 'none';
        
        // åªåœ¨ç»„ç»‡æ¶æ„é¡µé¢æ—¶æ¸²æŸ“
        if (currentPage === 'org') {
            render();
        }
    };

    function updateHint() {
        if (currentMode === 'parent') {
            desktopHint.innerHTML = `
                åœºæ™¯æµ‹è¯•ï¼ˆè¿”å›ä¸Šä¸€å±‚æ¨¡å¼ï¼‰ï¼š<br>
                1. åœ¨"é›†å›¢"è¾“å…¥"ä¸­å¿ƒ"æœç´¢ -> 2. ç‚¹å‡»è¿›å…¥"äº§ç ”ä¸­å¿ƒ" -> 3. è¾“å…¥"éƒ¨"æœç´¢ <br> 
                4. ç‚¹å‡»é¢åŒ…å±‘ä¸Šçš„"æœªæ¥ç§‘æŠ€é›†å›¢" -> <b>éªŒè¯ï¼šåº”æ¢å¤ç¬¬1æ­¥çš„æœç´¢è¯"ä¸­å¿ƒ"</b>
            `;
        } else {
            desktopHint.innerHTML = `
                <b>é€»è¾‘æµ‹è¯•ï¼ˆè¿”å›=å›é€€æ¨¡å¼ï¼‰ï¼š</b><br>
                1. ä¾æ¬¡è¿›å…¥: é›†å›¢ -> äº§ç ” -> æŠ€æœ¯éƒ¨ (åˆ—è¡¨æ˜¾ç¤ºæŠ€æœ¯éƒ¨)<br>
                2. ç‚¹å‡»é¢åŒ…å±‘ä¸Šçš„ "é›†å›¢" (å›åˆ°é¦–é¡µ)<br>
                3. <b>ç‚¹å‡»å·¦ä¸Šè§’è¿”å›</b> -> é¢„æœŸï¼šå›åˆ° "æŠ€æœ¯éƒ¨"
            `;
        }
    }

    // 4. æ ¸å¿ƒäº¤äº’æ–¹æ³• - æ ¹æ®æ¨¡å¼åˆ‡æ¢å®ç°

    // æ¨¡å¼1ï¼šè¿”å›ä¸Šä¸€å±‚ï¼ˆsliceç­–ç•¥ï¼‰
    function jumpToNodesParent(targetId) {
        const indexInStack = navigationStack.findIndex(item => item.id === targetId);
        
        if (indexInStack !== -1) {
            // ç­–ç•¥ Aï¼šå¦‚æœå†å²æ ˆé‡Œæœ‰ï¼Œåš"æ—¶å…‰å€’æµ"
            navigationStack = navigationStack.slice(0, indexInStack + 1);
        } else {
            // ç­–ç•¥ Bï¼šå¦‚æœå†å²æ ˆé‡Œæ²¡æœ‰ï¼Œæ„å»ºå®Œæ•´è·¯å¾„
            const path = getPath(targetId);
            if (path) {
                const newStack = [];
                for (let i = 0; i < path.length; i++) {
                    const nodeId = path[i].id;
                    const existingState = navigationStack.find(item => item.id === nodeId);
                    newStack.push({ 
                        id: nodeId, 
                        keyword: existingState ? existingState.keyword : '' 
                    });
                }
                navigationStack = newStack;
            } else {
                navigationStack = [{ id: targetId, keyword: '' }];
            }
        }
        
        render();
    }

    // æ¨¡å¼2ï¼šè¿”å›=å›é€€ï¼ˆpushç­–ç•¥ï¼‰
    function jumpToNodesBack(targetId) {
        let restoredKeyword = '';
        
        // å€’åºæŸ¥æ‰¾ï¼Œæ‰¾åˆ°æœ€è¿‘ä¸€æ¬¡è®¿é—®è¯¥IDçš„çŠ¶æ€
        for (let i = navigationStack.length - 1; i >= 0; i--) {
            if (navigationStack[i].id === targetId) {
                restoredKeyword = navigationStack[i].keyword;
                break;
            }
        }

        // Push æ–°å¢ï¼Œè€Œä¸æ˜¯ Slice
        navigationStack.push({ 
            id: targetId, 
            keyword: restoredKeyword 
        });
        
        render();
    }

    window.jumpToNodes = function(targetId) {
        if (currentMode === 'parent') {
            jumpToNodesParent(targetId);
        } else {
            jumpToNodesBack(targetId);
        }
    };

    window.enterDept = function(deptId) {
        if (currentMode === 'parent') {
            // æ¨¡å¼1ï¼šä¿å­˜å½“å‰æœç´¢çŠ¶æ€
            const currentState = navigationStack[navigationStack.length - 1];
            if (currentState) {
                currentState.keyword = searchInput.value.trim();
            }
            navigationStack.push({ id: deptId, keyword: '' });
        } else {
            // æ¨¡å¼2ï¼šç›´æ¥å…¥æ ˆ
            navigationStack.push({ id: deptId, keyword: '' });
        }
        render();
    };

    window.goBack = function() {
        // å¦‚æœä¸åœ¨ç»„ç»‡æ¶æ„é¡µé¢ï¼Œä¸å¤„ç†
        if (currentPage !== 'org') return;
        
        // æ£€æŸ¥æ˜¯å¦åº”è¯¥è¿”å›é€šè®¯å½•é¡µé¢
        // å¦‚æœæ ˆä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ä¸”æ˜¯ rootï¼Œæ— è®ºæ˜¯å¦æœ‰æœç´¢å…³é”®è¯ï¼Œéƒ½åº”è¯¥èƒ½è¿”å›é€šè®¯å½•
        const currentState = navigationStack[navigationStack.length - 1];
        if (navigationStack.length === 1 && currentState.id === 'root') {
            goBackFromOrg();
            return;
        }
        
        if (currentMode === 'parent') {
            // æ¨¡å¼1ï¼šè¿”å›åˆ°çˆ¶èŠ‚ç‚¹
            const path = getPath(currentState.id);
            
            if (path && path.length > 1) {
                const parentNode = path[path.length - 2];
                jumpToNodes(parentNode.id);
            } else if (navigationStack.length > 1) {
                navigationStack.pop();
                render();
            } else {
                // å¦‚æœå·²ç»åœ¨æ ¹èŠ‚ç‚¹ï¼Œè¿”å›é€šè®¯å½•
                goBackFromOrg();
            }
        } else {
            // æ¨¡å¼2ï¼šç®€å•çš„ Pop
            if (navigationStack.length > 1) {
                navigationStack.pop();
                render();
            } else {
                // å¦‚æœå·²ç»åœ¨æ ¹èŠ‚ç‚¹ï¼Œè¿”å›é€šè®¯å½•
                goBackFromOrg();
            }
        }
    };

    // æ¸²æŸ“ UI
    function render() {
        // åªåœ¨ç»„ç»‡æ¶æ„é¡µé¢æ—¶æ¸²æŸ“
        if (currentPage !== 'org') return;
        
        const state = navigationStack[navigationStack.length - 1];
        
        // æ›´æ–°è°ƒè¯•é¢æ¿ï¼ˆä»…åœ¨å›é€€æ¨¡å¼ä¸‹ï¼‰
        if (currentMode === 'back') {
            updateDebugPanel();
        }

        // æ¢å¤è¾“å…¥æ¡†å†…å®¹
        searchInput.value = state.keyword;

        // æ¸²æŸ“é¢åŒ…å±‘
        const path = getPath(state.id);
        if (path) {
            let breadHtml = path.map((node, index) => {
                const isLast = index === path.length - 1;
                return `
                    <span class="crumb-item ${isLast ? 'active' : ''}" 
                          onclick="${!isLast ? `jumpToNodes('${node.id}')` : ''}">${node.name}</span>
                    ${!isLast ? '<span class="crumb-separator">&gt;</span>' : ''}
                `;
            }).join('');
            breadcrumbsContainer.innerHTML = breadHtml;
            breadcrumbsContainer.scrollLeft = breadcrumbsContainer.scrollWidth;
        }

        // æ¸²æŸ“åˆ—è¡¨
        listContainer.innerHTML = '';
        
        if (state.keyword) {
            // æœç´¢æ€ - åªæœç´¢å½“å‰èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹
            const results = searchGlobal(state.keyword, state.id);
            if(results.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center;color:#999;padding:20px">æ— ç»“æœ</div>';
            } else {
                results.forEach(item => {
                   const el = document.createElement('div');
                   el.className = 'list-item';
                   
                   if(item.type === 'dept') {
                       if (currentMode === 'parent') {
                           // æ¨¡å¼1ï¼šä½¿ç”¨ jumpToNodes
                           el.onclick = () => {
                               const currentState = navigationStack[navigationStack.length - 1];
                               if (currentState) {
                                   currentState.keyword = searchInput.value.trim();
                               }
                               jumpToNodes(item.id);
                           };
                       } else {
                           // æ¨¡å¼2ï¼šä½¿ç”¨ enterDept
                           el.onclick = () => enterDept(item.id);
                       }
                   }
                   
                   const displayPath = item.fullPathName ? item.fullPathName.replace(/\s\/\s/g, ' > ') : '';
                   el.innerHTML = `
                       <div class="avatar ${item.type === 'dept' ? 'org' : (item.colorClass||'user-blue')} ${item.type === 'user' ? 'user-round' : ''}">${item.type==='user'?item.name[0]:''}</div>
                       <div class="info">
                           <div class="name">${highlightText(item.name, state.keyword)}</div>
                           <div class="sub-info">æ¥è‡ª: ${displayPath}</div>
                       </div>
                       ${item.type==='dept'?'<div class="arrow">â€º</div>':''}
                   `;
                   listContainer.appendChild(el);
                });
            }
        } else {
            // æµè§ˆæ€
            const node = findNodeById(state.id);
            if (node && node.children) {
                 const sorted = [...node.children].sort((a,b)=> (a.type===b.type)?0:(a.type==='dept'?-1:1));
                 sorted.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'list-item';
                    if(item.type === 'dept') el.onclick = () => enterDept(item.id);
                    el.innerHTML = `
                        <div class="avatar ${item.type === 'dept' ? 'org' : (item.colorClass||'user-blue')} ${item.type === 'user' ? 'user-round' : ''}">${item.type==='user'?item.name[0]:''}</div>
                        <div class="info"><div class="name">${item.name}</div></div>
                        ${item.title ? `<div class="tag-group"><div class="tag">${item.title}</div></div>` : ''}
                        ${item.type==='dept'?'<div class="arrow">â€º</div>':''}
                    `;
                    listContainer.appendChild(el);
                 });
            }
        }
    }

    function updateDebugPanel() {
        debugPanel.innerHTML = '<strong>History Stack (Bottom to Top):</strong><br><br>' + 
            navigationStack.map((s, i) => {
                const node = findNodeById(s.id);
                const name = node ? node.name : s.id;
                const kw = s.keyword ? ` [ğŸ”"${s.keyword}"]` : '';
                return `${i + 1}. ${name}${kw}${i===navigationStack.length-1 ? ' <span style="color:yellow">â† å½“å‰</span>' : ''}`;
            }).join('<br>');
        debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    // è¾“å…¥ç›‘å¬
    searchInput.addEventListener('input', (e) => {
        const val = e.target.value.trim();
        const currentState = navigationStack[navigationStack.length - 1];
        currentState.keyword = val;
        render();
    });

    document.addEventListener('keydown', (e) => { 
        if (currentPage === 'org' && e.key === 'ArrowLeft') {
            goBack();
        }
    });

    // åˆå§‹åŒ–
    updateHint();
    renderContactPage(); // åˆå§‹åŒ–é€šè®¯å½•é¡µé¢
</script>
</body>
</html>

